// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// PERSONAL AUTORIZADO - Whitelist de empleados del hospital
// Solo personal registrado aquí puede crear cuentas en el sistema
// Gestionado exclusivamente por autoridades del hospital
// ============================================
model PersonalAutorizado {
  id                Int   @id @default(autoincrement())
  ci                String   @unique @db.VarChar(50) // Cédula de identidad (único identificador)
  nombreCompleto    String   @db.VarChar(200) // Nombre como aparece en documentos oficiales
  email             String?  @db.VarChar(200) // Email institucional (opcional para pre-registro)
  rolAutorizado     String   @db.VarChar(50) // MEDICO | ADMIN | COORDINADOR | ENFERMERO | SUPER_ADMIN
  departamento      String?  @db.VarChar(100) // Departamento/Servicio asignado
  especialidad      String?  @db.VarChar(100) // Especialidad médica (si es MEDICO)
  cargo             String?  @db.VarChar(100) // Cargo específico
  
  // Control de vigencia
  estado            String   @default("ACTIVO") @db.VarChar(50) // ACTIVO | INACTIVO | SUSPENDIDO | BAJA
  fechaIngreso      DateTime @db.Date // Fecha de ingreso al hospital
  fechaVencimiento  DateTime? @db.Date // Fecha hasta cuando está autorizado (null = indefinido)
  
  // Auditoría
  motivoBaja        String?  @db.Text // Razón de inactivación/baja
  autorizadoPor     String?  @db.VarChar(200) // Nombre de autoridad que lo agregó
  
  // Control de registro
  registrado        Boolean  @default(false) // Si ya creó su cuenta en el sistema
  fechaRegistro     DateTime? @db.Timestamptz // Cuándo se registró en la PWA
  usuarioId         Int?  @unique // Referencia al usuario creado (1:1)
  
  createdAt         DateTime @default(now()) @db.Timestamptz()
  updatedAt         DateTime @updatedAt @db.Timestamptz()
  
  // Relación con Usuario (opcional, se llena cuando se registra)
  usuario           Usuario? @relation(fields: [usuarioId], references: [id])
  
  @@index([ci])
  @@index([estado])
  @@index([rolAutorizado])
  @@index([registrado])
}

// ============================================
// PACIENTES - Información básica del paciente
// ============================================
model Paciente {
  id               Int    @id @default(autoincrement())
  nroHistoria      String    @unique @db.VarChar(50)
  apellidosNombres String    @db.VarChar(200)
  ci               String    @unique @db.VarChar(50)
  fechaNacimiento  DateTime? @db.Date
  sexo             String?   @db.VarChar(3) // CHECK: M, F
  nacionalidad        String?   @db.VarChar(100)
  direccion           String?   @db.VarChar(300)
  telefono            String?   @db.VarChar(50)
  telefonoEmergencia  String?   @db.VarChar(50)
  lugarNacimiento     String?   @db.VarChar(200)
  religion            String?   @db.VarChar(100)
  estado              String?   @db.VarChar(100)
  tipoPaciente        String    @default("PNA") @db.VarChar(50) // MILITAR | AFILIADO | PNA
  estadoRegistro   String    @default("PERMANENTE") @db.VarChar(50) // TEMPORAL | PERMANENTE | NN
  createdAt        DateTime  @default(now()) @db.Timestamptz()
  updatedAt        DateTime  @updatedAt @db.Timestamptz()

  // Relaciones
  personalMilitar         PersonalMilitar?
  afiliado                Afiliado?
  admisiones              Admision[]
  encuentros              Encuentro[]
  antecedentes            Antecedente[]
  citas                   Cita[]                   @relation("CitasPaciente")
  formatosHospitalizacion FormatoHospitalizacion[]
  interconsultas          Interconsulta[]

  @@index([ci])
  @@index([nroHistoria])
  @@index([estadoRegistro])
  @@index([tipoPaciente])
}

// ============================================
// PERSONAL MILITAR - Info militar del paciente
// ============================================
model PersonalMilitar {
  id            Int  @id @default(autoincrement())
  pacienteId    Int  @unique
  grado         String? @db.VarChar(50)
  componente    String? @db.VarChar(100)
  unidad        String? @db.VarChar(200)
  estadoMilitar String? @db.VarChar(50) // activo, disponible, resActiva

  // Relaciones
  paciente Paciente @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
}

// ============================================
// AFILIADO - Info de afiliación del paciente
// ============================================
model Afiliado {
  id                Int     @id @default(autoincrement())
  pacienteId        Int     @unique
  nroCarnet         String? @db.VarChar(100) // Número de carnet del afiliado
  parentesco        String? @db.VarChar(100) // Relación con el militar (esposo/a, hijo/a, padre/madre, etc.)
  titularNombre     String? @db.VarChar(200) // Nombre del militar titular
  titularCi         String? @db.VarChar(50)  // CI del militar titular
  titularGrado      String? @db.VarChar(50)  // Grado del militar titular
  titularComponente String? @db.VarChar(100) // Componente del militar titular
  fechaAfiliacion   DateTime? @db.Date       // Fecha de afiliación al servicio
  vigente           Boolean @default(true)   // Si la afiliación está vigente
  
  createdAt DateTime @default(now()) @db.Timestamptz()
  updatedAt DateTime @updatedAt @db.Timestamptz()

  // Relaciones
  paciente Paciente @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  
  @@index([titularCi])
  @@index([nroCarnet])
}

// ============================================
// USUARIOS - Médicos y administrativos
// ============================================
model Usuario {
  id        Int   @id @default(autoincrement())
  nombre    String   @db.VarChar(200)
  email     String   @unique @db.VarChar(200)
  password  String   @db.VarChar(255)
  ci        String?  @unique @db.VarChar(50)
  cargo     String?  @db.VarChar(100)
  especialidad String? @db.VarChar(100) // Especialidad médica (para interconsultas)
  role      String?  @db.VarChar(50) // MEDICO, ENFERMERO, ADMIN, COORDINADOR, SUPER_ADMIN
  createdAt DateTime @default(now()) @db.Timestamptz()
  updatedAt DateTime @updatedAt @db.Timestamptz()

  // Relaciones
  admisionesCreadas         Admision[]           @relation("AdmisionesCreadas")
  encuentros                Encuentro[]
  auditorias                AuditLog[]
  citas                     Cita[]               @relation("CitasMedico")
  laboratorios              Laboratorio[]
  estudiosEspeciales        EstudioEspecial[]
  electrocardiogramas       Electrocardiograma[]
  ordenesMedicasOrdena      OrdenMedica[]        @relation("OrdenesMedicasOrdena")
  ordenesMedicasCumple      OrdenMedica[]        @relation("OrdenesMedicasCumple")
  evolucionesMedicas        EvolucionMedica[]
  personalAutorizado        PersonalAutorizado?  // Relación inversa con whitelist
  interconsultasSolicitadas Interconsulta[]      @relation("InterconsultasSolicitadas")
  interconsultasRecibidas   Interconsulta[]      @relation("InterconsultasRecibidas")
  horariosDisponibilidad    HorarioMedico[]      // Horarios de disponibilidad

  @@index([email])
  @@index([ci])
  @@index([especialidad])
}

// ============================================
// ADMISION - Registro de admisión inicial
// ============================================
model Admision {
  id         Int @id @default(autoincrement())
  pacienteId Int

  // Tipo y servicio (null para admisión inicial, se completa con "Registrar Admisión")
  tipo            String?  @db.VarChar(50) // EMERGENCIA | HOSPITALIZACION | CONSULTA_EXTERNA | UCI | CIRUGIA
  servicio        String?  @db.VarChar(100) // EMERGENCIA | MEDICINA_INTERNA | CIRUGIA_GENERAL | UCI | PEDIATRIA | etc.

  // Diagnóstico de ingreso (opcional, se registra en la admisión inicial)
  diagnosticoIngreso String? @db.Text

  // Fechas y horas
  fechaAdmision DateTime  @db.Date
  horaAdmision  String?   @db.VarChar(8) // Formato: HH:MM
  fechaAlta     DateTime? @db.Date
  horaAlta      String?   @db.VarChar(8) // Formato: HH:MM

  // Datos de ingreso
  formaIngreso String? @db.VarChar(20) // AMBULANTE | AMBULANCIA | TRANSFERENCIA
  habitacion   String? @db.VarChar(50)
  cama         String? @db.VarChar(50)

  // Estado de la admisión
  estado   String  @default("ACTIVA") @db.VarChar(50) // ACTIVA | ALTA | TRANSFERIDO | FALLECIDO | CANCELADA | EN_ESPERA
  tipoAlta String? @db.VarChar(50) // MEJORIA | VOLUNTARIA | TRANSFERENCIA | FALLECIMIENTO | FUGA | ADMINISTRATIVA

  // Otros
  firmaFacultativo String? @db.VarChar(200)
  observaciones    String? @db.Text

  createdById Int?
  createdAt   DateTime @default(now()) @db.Timestamptz()
  updatedAt   DateTime @updatedAt @db.Timestamptz()

  // Relaciones
  paciente               Paciente                @relation(fields: [pacienteId], references: [id])
  createdBy              Usuario?                @relation("AdmisionesCreadas", fields: [createdById], references: [id])
  estanciaHospitalaria   EstanciaHospitalaria?
  encuentros             Encuentro[]
  formatoEmergencia      FormatoEmergencia?
  formatoHospitalizacion FormatoHospitalizacion?
  interconsultas         Interconsulta[]

  @@index([pacienteId])
  @@index([fechaAdmision])
  @@index([tipo])
  @@index([estado])
  @@index([servicio])
}

// ============================================
// ESTANCIA HOSPITALARIA - Alta y cálculo días
// ============================================
model EstanciaHospitalaria {
  id                   Int    @id @default(autoincrement())
  admisionId           Int    @unique
  fechaAlta            DateTime? @db.Date
  diasHosp             Int?
  diagnosticoIngresoId Int?
  diagnosticoEgresoId  Int?
  notas                String?   @db.Text
  updatedAt            DateTime  @updatedAt @db.Timestamptz()

  // Relaciones
  admision           Admision     @relation(fields: [admisionId], references: [id], onDelete: Cascade)
  diagnosticoIngreso Diagnostico? @relation("ingreso", fields: [diagnosticoIngresoId], references: [id])
  diagnosticoEgreso  Diagnostico? @relation("egreso", fields: [diagnosticoEgresoId], references: [id])
}

// ============================================
// DIAGNOSTICOS - Catálogo de diagnósticos CIE
// ============================================
model Diagnostico {
  id          Int   @id @default(autoincrement())
  codigoCie   String?  @db.VarChar(20)
  descripcion String   @db.VarChar(500)
  tipo        String?  @db.VarChar(20)
  createdAt   DateTime @default(now()) @db.Timestamptz()

  // Relaciones
  estanciaIngresos EstanciaHospitalaria[] @relation("ingreso")
  estanciaEgresos  EstanciaHospitalaria[] @relation("egreso")

  @@index([codigoCie])
}

// ============================================
// ENCUENTROS - Visitas/atenciones (emergencia, hospitalización, consulta)
// ============================================
model Encuentro {
  id               Int    @id @default(autoincrement())
  pacienteId       Int
  admisionId       Int?
  tipo             String    @db.VarChar(30) // CHECK: EMERGENCIA, HOSPITALIZACION, CONSULTA, OTRO
  fecha            DateTime  @db.Date
  hora             String?   @db.VarChar(8) // Formato: HH:MM
  motivoConsulta   String?   @db.VarChar(1000)
  enfermedadActual String?   @db.Text
  procedencia      String?   @db.VarChar(200)
  nroCama          String?   @db.VarChar(50)
  examenFisico     Json?     // Examen físico genérico (JSONB) - personalizable por especialidad
  createdById      Int?
  createdAt        DateTime  @default(now()) @db.Timestamptz()
  updatedAt        DateTime  @updatedAt @db.Timestamptz()

  // Relaciones
  paciente       Paciente               @relation(fields: [pacienteId], references: [id])
  admision       Admision?              @relation(fields: [admisionId], references: [id])
  createdBy      Usuario?               @relation(fields: [createdById], references: [id])
  examenRegional ExamenRegional?
  impresiones    ImpresionDiagnostica[]

  @@index([pacienteId, fecha])
}

// ============================================
// EXAMEN REGIONAL - Examen físico por regiones
// ============================================
model ExamenRegional {
  id          Int  @id @default(autoincrement())
  encuentroId Int  @unique
  piel        String? @db.Text
  cabeza      String? @db.Text
  cuello      String? @db.Text
  torax       String? @db.Text
  pulmones    String? @db.Text
  corazon     String? @db.Text
  abdomen     String? @db.Text
  anoRecto    String? @db.Text
  genitales   String? @db.Text

  // Relaciones
  encuentro Encuentro @relation(fields: [encuentroId], references: [id], onDelete: Cascade)
}

// ============================================
// ANTECEDENTES - Historial personal/familiar
// ============================================
model Antecedente {
  id           Int   @id @default(autoincrement())
  pacienteId   Int
  tipo         String   @db.VarChar(20) // CHECK: PERSONAL, FAMILIAR, OTRO
  descripcion  String   @db.Text
  registradoEn DateTime @default(now()) @db.Timestamptz()

  // Relaciones
  paciente Paciente @relation(fields: [pacienteId], references: [id], onDelete: Cascade)

  @@index([pacienteId])
}

// ============================================
// IMPRESIONES DIAGNOSTICAS - Diagnósticos del encuentro
// ============================================
model ImpresionDiagnostica {
  id          Int   @id @default(autoincrement())
  encuentroId Int
  codigoCie   String?  @db.VarChar(100)
  descripcion String?  @db.Text
  clase       String   @default("PRESUNTIVO") @db.VarChar(20) // CHECK: PRESUNTIVO, CONFIRMADO
  createdAt   DateTime @default(now()) @db.Timestamptz()

  // Relaciones
  encuentro Encuentro @relation(fields: [encuentroId], references: [id], onDelete: Cascade)

  @@index([codigoCie])
  @@index([encuentroId])
}

// ============================================
// AUDIT LOG - Cambios críticos y auditoría
// ============================================
model AuditLog {
  id         Int   @id @default(autoincrement())
  tabla      String   @db.VarChar(100)
  registroId Int?
  usuarioId  Int?
  accion     String   @db.VarChar(50) // CREATE, UPDATE, DELETE
  detalle    Json? // Campo JSONB para detalles
  creadoEn   DateTime @default(now()) @db.Timestamptz()

  // Relaciones
  usuario Usuario? @relation(fields: [usuarioId], references: [id])

  @@index([tabla])
  @@index([usuarioId])
}

// ============================================
// CITA - Cita médica programada
// ============================================
model Cita {
  id                  Int    @id @default(autoincrement())
  pacienteId          Int
  medicoId            Int?
  fechaCita           DateTime  @db.Date
  horaCita            String?   @db.VarChar(8) // Formato: HH:MM:SS o HH:MM
  especialidad        String    @db.VarChar(100)
  motivo              String?   @db.VarChar(500)
  estado              String    @default("PROGRAMADA") @db.VarChar(50) // CHECK: PROGRAMADA, REALIZADA, CANCELADA, NO_ASISTIO
  notas               String?   @db.Text
  recordatorioEnviado Boolean   @default(false)
  createdAt           DateTime  @default(now()) @db.Timestamptz()
  updatedAt           DateTime  @updatedAt @db.Timestamptz()

  // Relaciones
  paciente Paciente @relation("CitasPaciente", fields: [pacienteId], references: [id], onDelete: Cascade)
  medico   Usuario? @relation("CitasMedico", fields: [medicoId], references: [id])

  @@index([pacienteId])
  @@index([fechaCita])
  @@index([estado])
}

// ============================================
// FORMATO EMERGENCIA - Datos clínicos de emergencia
// ============================================
model FormatoEmergencia {
  id         Int @id @default(autoincrement())
  admisionId Int @unique

  // 1. ANAMNESIS
  // 1.1. FILIACION (se obtiene del paciente, no se duplica aquí)
  
  // MOTIVO DE CONSULTA
  motivoConsulta   String? @db.Text
  
  // 1.2. ENFERMEDAD ACTUAL
  enfermedadActual String? @db.Text
  
  // 1.3. ANTECEDENTES PATOLOGICOS
  antecedentesPersonales    String? @db.Text
  antecedentesFamiliares    String? @db.Text
  habitosPsicobiologicos    String? @db.Text

  // 2. EXAMEN FISICO
  // 2.1. FUNCIONES VITALES
  fechaExamen  DateTime? @db.Date
  horaExamen   DateTime? @db.Time
  peso         Decimal?  @db.Decimal(5, 2) // en kg
  talla        Decimal?  @db.Decimal(5, 2) // en cm
  fc           Int?      // Frecuencia Cardíaca (x')
  fr           Int?      // Frecuencia Respiratoria (x')
  temperatura  Decimal?  @db.Decimal(4, 2) // en °C
  taSistolica  Int?      // Presión Arterial Sistólica
  taDiastolica Int?      // Presión Arterial Diastólica
  
  // 2.2. EXAMEN GENERAL
  examenGeneral String? @db.Text
  
  // 2.3. EXAMEN REGIONAL
  piel            String? @db.Text
  cabeza          String? @db.Text
  cuello          String? @db.Text
  torax           String? @db.Text
  pulmones        String? @db.Text
  cardiovascular  String? @db.Text
  abdomen         String? @db.Text
  genital         String? @db.Text
  anoRecto        String? @db.Text
  neurologico     String? @db.Text
  
  // 3. IMPRESION DIAGNOSTICA
  impresionDx             String? @db.Text
  
  // Control y seguimiento
  requiereHospitalizacion Boolean @default(false)
  observaciones           String? @db.Text

  createdAt DateTime @default(now()) @db.Timestamptz()
  updatedAt DateTime @updatedAt @db.Timestamptz()

  // Relaciones
  admision Admision @relation(fields: [admisionId], references: [id], onDelete: Cascade)

  @@index([admisionId])
  @@index([fechaExamen])
}

// ============================================
// FORMATO HOSPITALIZACION - Formato completo de hospitalización (11 secciones)
// ============================================
model FormatoHospitalizacion {
  id         Int @id @default(autoincrement())
  admisionId Int @unique
  pacienteId Int

  // Metadatos
  fechaCreacion       DateTime @default(now()) @db.Timestamptz()
  ultimaActualizacion DateTime @updatedAt @db.Timestamptz()

  // Relaciones
  admision Admision @relation(fields: [admisionId], references: [id], onDelete: Cascade)
  paciente Paciente @relation(fields: [pacienteId], references: [id])

  // Sub-documentos relacionados (11 secciones del formato)
  signosVitales          SignosVitalesHosp[]
  laboratorios           Laboratorio[]
  estudiosEspeciales     EstudioEspecial[]
  electrocardiogramas    Electrocardiograma[]
  antecedentesDetallados AntecedentesDetallados?
  examenFuncional        ExamenFuncional?
  examenFisicoCompleto   ExamenFisicoCompleto?
  resumenIngreso         ResumenIngreso?
  ordenesMedicas         OrdenMedica[]
  evolucionesMedicas     EvolucionMedica[]

  @@index([admisionId])
  @@index([pacienteId])
}

// ============================================
// SIGNOS VITALES HOSPITALIZACION - Registro múltiple de signos vitales
// ============================================
model SignosVitalesHosp {
  id            Int   @id @default(autoincrement())
  formatoHospId Int
  medicoId      Int
  hora          DateTime @db.Time

  // Signos vitales completos
  taSistolica  Int?
  taDiastolica Int?
  tam          Decimal? @db.Decimal(5, 2) // Tensión Arterial Media
  fc           Int? // Frecuencia Cardíaca
  fr           Int? // Frecuencia Respiratoria
  temperatura  Decimal? @db.Decimal(4, 2)
  spo2         Int? // Saturación de Oxígeno

  observacion   String?  @db.Text
  registradoPor Int?
  createdAt     DateTime @default(now()) @db.Timestamptz()

  // Relaciones
  formatoHosp FormatoHospitalizacion @relation(fields: [formatoHospId], references: [id], onDelete: Cascade)

  @@index([formatoHospId])
}

// ============================================
// HORARIO MEDICO - Disponibilidad de médicos por especialidad
// ============================================
model HorarioMedico {
  id               Int      @id @default(autoincrement())
  usuarioId        Int
  especialidad     String   @db.VarChar(100)
  diaSemana        Int
  horaInicio       String   @db.VarChar(8)
  horaFin          String   @db.VarChar(8)
  capacidadPorDia  Int
  activo           Boolean  @default(true)
  createdAt        DateTime @default(now()) @db.Timestamptz()
  updatedAt        DateTime @updatedAt @db.Timestamptz()

  usuario          Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([especialidad])
  @@index([diaSemana])
  @@unique([usuarioId, especialidad, diaSemana])
}

// ============================================
// LABORATORIO - Resultados de laboratorio (44 parámetros)
// ============================================
model Laboratorio {
  id            Int    @id @default(autoincrement())
  formatoHospId Int
  fecha         DateTime  @db.Date
  hora          DateTime? @db.Time

  // Hematología
  hgb         Decimal? @db.Decimal(5, 2) // Hemoglobina
  hct         Decimal? @db.Decimal(5, 2) // Hematocrito
  vcm         Decimal? @db.Decimal(5, 2) // Volumen Corpuscular Medio
  chcm        Decimal? @db.Decimal(5, 2) // Concentración Hemoglobina Corpuscular Media
  leucocitos  Decimal? @db.Decimal(10, 2)
  neutrofilos Decimal? @db.Decimal(5, 2)
  linfocitos  Decimal? @db.Decimal(5, 2)
  eosinofilos Decimal? @db.Decimal(5, 2)
  plaquetas   Decimal? @db.Decimal(10, 2)

  // Coagulación
  pt          Decimal? @db.Decimal(5, 2) // Tiempo de Protrombina
  ptt         Decimal? @db.Decimal(5, 2) // Tiempo de Tromboplastina Parcial
  inr         Decimal? @db.Decimal(4, 2)
  fibrinogeno Decimal? @db.Decimal(7, 2)

  // Reactantes de Fase Aguda
  vsg Decimal? @db.Decimal(5, 2) // Velocidad de Sedimentación Globular
  pcr Decimal? @db.Decimal(7, 2) // Proteína C Reactiva

  // Química Sanguínea
  glicemia              Decimal? @db.Decimal(7, 2)
  urea                  Decimal? @db.Decimal(7, 2)
  creatinina            Decimal? @db.Decimal(5, 2)
  amilasa               Decimal? @db.Decimal(7, 2)
  lipasa                Decimal? @db.Decimal(7, 2)
  tgo                   Decimal? @db.Decimal(7, 2) // Transaminasa Glutámico Oxalacética
  tgp                   Decimal? @db.Decimal(7, 2) // Transaminasa Glutámico Pirúvica
  troponina             Decimal? @db.Decimal(7, 4)
  fosfatasa_alcalina    Decimal? @db.Decimal(7, 2)
  bilirrubina_total     Decimal? @db.Decimal(5, 2)
  bilirrubina_directa   Decimal? @db.Decimal(5, 2)
  bilirrubina_indirecta Decimal? @db.Decimal(5, 2)
  acido_urico           Decimal? @db.Decimal(5, 2)
  proteinas_totales     Decimal? @db.Decimal(5, 2)
  albumina              Decimal? @db.Decimal(5, 2)
  globulina             Decimal? @db.Decimal(5, 2)
  ldh                   Decimal? @db.Decimal(7, 2) // Lactato Deshidrogenasa
  colesterol            Decimal? @db.Decimal(7, 2)
  trigliceridos         Decimal? @db.Decimal(7, 2)

  // Electrolitos
  sodio   Decimal? @db.Decimal(5, 2)
  potasio Decimal? @db.Decimal(4, 2)
  cloro   Decimal? @db.Decimal(5, 2)

  // Marcadores Especiales
  ferritina Decimal? @db.Decimal(7, 2)
  dimero_d  Decimal? @db.Decimal(7, 2)
  ck        Decimal? @db.Decimal(7, 2) // Creatinquinasa
  ckmb      Decimal? @db.Decimal(7, 2) // Creatinquinasa MB

  observaciones String?  @db.Text
  registradoPor Int?
  createdAt     DateTime @default(now()) @db.Timestamptz()

  // Relaciones
  formatoHosp FormatoHospitalizacion @relation(fields: [formatoHospId], references: [id], onDelete: Cascade)
  usuario     Usuario?               @relation(fields: [registradoPor], references: [id])

  @@index([formatoHospId])
  @@index([fecha])
}

// ============================================
// ESTUDIO ESPECIAL - Estudios de imágenes y otros
// ============================================
model EstudioEspecial {
  id            Int    @id @default(autoincrement())
  formatoHospId Int
  fecha         DateTime  @db.Date
  hora          DateTime? @db.Time

  tipoEstudio String  @db.VarChar(100) // Rx, TAC, RMN, Eco, Endoscopia, etc.
  descripcion String  @db.Text
  resultado   String? @db.Text
  archivoUrl  String? @db.VarChar(500) // URL del archivo adjunto

  registradoPor Int?
  createdAt     DateTime @default(now()) @db.Timestamptz()

  // Relaciones
  formatoHosp FormatoHospitalizacion @relation(fields: [formatoHospId], references: [id], onDelete: Cascade)
  usuario     Usuario?               @relation(fields: [registradoPor], references: [id])

  @@index([formatoHospId])
  @@index([fecha])
  @@index([tipoEstudio])
}

// ============================================
// ELECTROCARDIOGRAMA - Interpretación de EKG
// ============================================
model Electrocardiograma {
  id            Int    @id @default(autoincrement())
  formatoHospId Int
  fecha         DateTime  @db.Date
  hora          DateTime? @db.Time

  interpretacion String? @db.Text
  ritmo          String? @db.VarChar(100)
  frecuencia     Int?
  hallazgos      String? @db.Text
  archivoUrl     String? @db.VarChar(500) // URL de la imagen del EKG

  registradoPor Int?
  createdAt     DateTime @default(now()) @db.Timestamptz()

  // Relaciones
  formatoHosp FormatoHospitalizacion @relation(fields: [formatoHospId], references: [id], onDelete: Cascade)
  usuario     Usuario?               @relation(fields: [registradoPor], references: [id])

  @@index([formatoHospId])
  @@index([fecha])
}

// ============================================
// ANTECEDENTES DETALLADOS - Antecedentes completos del paciente (CLINICA II)
// ============================================
model AntecedentesDetallados {
  id            Int @id @default(autoincrement())
  formatoHospId Int @unique

  // Antecedentes Personales
  patologiaBase              String? @db.Text
  alergiaMedicamentos        String? @db.Text
  antecedentesQx             String? @db.Text
  transfusionesSanguineas    String? @db.Text
  traumatismos               String? @db.Text
  hospitalizacionesRecientes String? @db.Text

  // Antecedentes Familiares
  madre            String? @db.Text
  padre            String? @db.Text
  hermanos         String? @db.Text
  hermanasCantidad Int?
  hermanosCantidad Int?
  hijasCantidad    Int?
  hijosCantidad    Int?

  // Hábitos Psicobiológicos
  cafeinicos           String?  @db.Text
  tabaquicos           String?  @db.Text
  ipa                  Decimal? @db.Decimal(5, 2) // Índice Paquetes/Año
  alcoholicos          String?  @db.Text
  drogas               String?  @db.Text
  adiccionMedicamentos String?  @db.Text

  // Antecedentes Epidemiológicos
  viajesRecientes         String?  @db.Text
  residenciaZona          String?  @db.VarChar(200)
  viviendaTipo            String?  @db.VarChar(100)
  viviendaSalas           Int?
  viviendaCocina          Boolean?
  viviendaComedor         Boolean?
  viviendaBanos           Int?
  viviendaCuartos         Int?
  viviendaPersonasCant    Int?
  servicioElectricidad    Boolean?
  servicioAguasBlancas    Boolean?
  servicioAguasResiduales Boolean?
  servicioGasDomestico    Boolean?
  servicioAseoUrbano      Boolean?
  contactoAnimales        String?  @db.Text
  vectores                String?  @db.Text
  contactoTB              Boolean?
  privadosLibertad        Boolean?
  pacienteCovid           Boolean?
  tosedoresCronicos       Boolean?
  parejasSexuales         String?  @db.VarChar(100)
  otrosEpidemiologicos    String?  @db.Text

  createdAt DateTime @default(now()) @db.Timestamptz()
  updatedAt DateTime @updatedAt @db.Timestamptz()

  // Relaciones
  formatoHosp FormatoHospitalizacion @relation(fields: [formatoHospId], references: [id], onDelete: Cascade)

  @@index([formatoHospId])
}

// ============================================
// EXAMEN FUNCIONAL - Revisión por sistemas (CLINICA II)
// ============================================
model ExamenFuncional {
  id            Int @id @default(autoincrement())
  formatoHospId Int @unique

  general          String? @db.Text
  piel             String? @db.Text
  cabeza           String? @db.Text
  ojos             String? @db.Text
  oidos            String? @db.Text
  nariz            String? @db.Text
  boca             String? @db.Text
  garganta         String? @db.Text
  respiratorio     String? @db.Text
  cardiovascular   String? @db.Text
  genitourinario   String? @db.Text
  gastrointestinal String? @db.Text
  nervioso         String? @db.Text
  oma              String? @db.Text // Órganos, Músculos, Articulaciones

  createdAt DateTime @default(now()) @db.Timestamptz()
  updatedAt DateTime @updatedAt @db.Timestamptz()

  // Relaciones
  formatoHosp FormatoHospitalizacion @relation(fields: [formatoHospId], references: [id], onDelete: Cascade)

  @@index([formatoHospId])
}

// ============================================
// EXAMEN FISICO COMPLETO - Examen físico detallado (CLINICA III)
// ============================================
model ExamenFisicoCompleto {
  id            Int    @id @default(autoincrement())
  formatoHospId Int    @unique
  fecha         DateTime  @default(now()) @db.Date
  hora          DateTime? @db.Time

  // Signos vitales al momento del examen
  taSistolica  Int?
  taDiastolica Int?
  fc           Int?
  fr           Int?
  temperatura  Decimal? @db.Decimal(4, 2)
  spo2         Int?
  peso         Decimal? @db.Decimal(5, 2)
  talla        Decimal? @db.Decimal(5, 2)

  // Examen físico por regiones
  piel         String? @db.Text
  cabeza       String? @db.Text
  ojos         String? @db.Text
  oidos        String? @db.Text
  boca         String? @db.Text
  cuello       String? @db.Text
  cp           String? @db.Text // Cardiopulmonar
  abdomen      String? @db.Text
  genitales    String? @db.Text
  extremidades String? @db.Text
  neurologico  String? @db.Text

  createdAt DateTime @default(now()) @db.Timestamptz()
  updatedAt DateTime @updatedAt @db.Timestamptz()

  // Relaciones
  formatoHosp FormatoHospitalizacion @relation(fields: [formatoHospId], references: [id], onDelete: Cascade)

  @@index([formatoHospId])
}

// ============================================
// RESUMEN DE INGRESO - Documento consolidado (CLINICA I + resumen)
// ============================================
model ResumenIngreso {
  id            Int    @id @default(autoincrement())
  formatoHospId Int    @unique
  fecha         DateTime  @db.Date
  hora          DateTime? @db.Time

  // Clínica I
  motivoConsulta   String? @db.Text
  enfermedadActual String? @db.Text

  // Resumen de antecedentes
  antecedentesResumen String? @db.Text

  // Examen físico resumido
  examenFisicoResumen String? @db.Text

  // Impresión diagnóstica inicial
  impresionDxInicial String? @db.Text

  createdAt DateTime @default(now()) @db.Timestamptz()
  updatedAt DateTime @updatedAt @db.Timestamptz()

  // Relaciones
  formatoHosp FormatoHospitalizacion @relation(fields: [formatoHospId], references: [id], onDelete: Cascade)

  @@index([formatoHospId])
}

// ============================================
// ORDEN MEDICA - Órdenes médicas durante hospitalización
// ============================================
model OrdenMedica {
  id            Int   @id @default(autoincrement())
  formatoHospId Int
  fecha         DateTime @db.Date
  hora          DateTime @db.Time

  tipoOrden    String  @db.VarChar(50) // MEDICAMENTO | ESTUDIO | DIETA | PROCEDIMIENTO | INTERCONSULTA
  descripcion  String  @db.Text
  indicaciones String? @db.Text

  estado            String    @default("PENDIENTE") @db.VarChar(50) // PENDIENTE | CUMPLIDA | CANCELADA
  fechaCumplimiento DateTime?

  archivoUrl String? @db.VarChar(500) // Recipe o documento adjunto

  ordenadoPor Int?
  cumplidaPor Int?

  createdAt DateTime @default(now()) @db.Timestamptz()
  updatedAt DateTime @updatedAt @db.Timestamptz()

  // Relaciones
  formatoHosp  FormatoHospitalizacion @relation(fields: [formatoHospId], references: [id], onDelete: Cascade)
  medicoOrdena Usuario?               @relation("OrdenesMedicasOrdena", fields: [ordenadoPor], references: [id])
  medicoCumple Usuario?               @relation("OrdenesMedicasCumple", fields: [cumplidaPor], references: [id])

  @@index([formatoHospId])
  @@index([fecha])
  @@index([estado])
  @@index([tipoOrden])
}

// ============================================
// EVOLUCION MEDICA - Notas de evolución diarias
// ============================================
model EvolucionMedica {
  id            Int   @id @default(autoincrement())
  formatoHospId Int
  fecha         DateTime @db.Date
  hora          DateTime @db.Time
  cama          String?  @db.VarChar(50)

  diasHospitalizacion Int? // D.H. (días)
  impresionDx         String? @db.Text

  // SOAP (Subjetivo, Objetivo, Análisis, Plan)
  subjetivo String? @db.Text
  objetivo  String? @db.Text

  // Signos vitales del momento
  taSistolica  Int?
  taDiastolica Int?
  fc           Int?
  fr           Int?
  spo2         Int?
  temperatura  Decimal? @db.Decimal(4, 2)

  // Examen físico dirigido
  piel         String? @db.Text
  cp           String? @db.Text // Cardiopulmonar
  abdomen      String? @db.Text
  extremidades String? @db.Text
  neurologico  String? @db.Text

  notas String? @db.Text

  evolucionadoPor Int?
  createdAt       DateTime @default(now()) @db.Timestamptz()

  // Relaciones
  formatoHosp FormatoHospitalizacion @relation(fields: [formatoHospId], references: [id], onDelete: Cascade)
  medico      Usuario?               @relation(fields: [evolucionadoPor], references: [id])

  @@index([formatoHospId])
  @@index([fecha])
}

// ============================================
// INTERCONSULTA - Solicitudes entre especialidades médicas
// Permite que un médico refiera/transfiera pacientes a otras especialidades
// ============================================
model Interconsulta {
  id         Int   @id @default(autoincrement())
  pacienteId Int
  admisionId Int?  // Opcional: si está relacionada a una admisión activa

  // Médico que solicita la interconsulta
  medicoSolicitanteId Int
  especialidadOrigen  String @db.VarChar(100) // Especialidad del médico solicitante

  // Destino de la interconsulta
  especialidadDestino String  @db.VarChar(100) // Especialidad a la que se refiere
  medicoDestinoId     Int? // Médico específico (opcional, puede ser cualquiera de la especialidad)

  // Información clínica
  motivoInterconsulta   String  @db.Text // Por qué se solicita la interconsulta
  resumenClinico        String? @db.Text // Resumen del estado actual del paciente
  preguntaEspecifica    String? @db.Text // Pregunta concreta al especialista
  diagnosticoPresuntivo String? @db.Text // Diagnóstico actual/presuntivo

  // Prioridad y urgencia
  prioridad String @default("NORMAL") @db.VarChar(20) // URGENTE | ALTA | NORMAL | BAJA

  // Estado del flujo
  estado String @default("PENDIENTE") @db.VarChar(30) // PENDIENTE | EN_PROCESO | COMPLETADA | CANCELADA | RECHAZADA

  // Respuesta del especialista
  respuestaInterconsulta String?   @db.Text // Respuesta/conclusiones del especialista
  recomendaciones        String?   @db.Text // Recomendaciones del especialista
  fechaRespuesta         DateTime? @db.Timestamptz

  // Fechas de control
  fechaSolicitud DateTime @default(now()) @db.Timestamptz()
  fechaAceptacion DateTime? @db.Timestamptz // Cuando el especialista acepta atenderla

  createdAt DateTime @default(now()) @db.Timestamptz()
  updatedAt DateTime @updatedAt @db.Timestamptz()

  // Relaciones
  paciente          Paciente  @relation(fields: [pacienteId], references: [id])
  admision          Admision? @relation(fields: [admisionId], references: [id])
  medicoSolicitante Usuario   @relation("InterconsultasSolicitadas", fields: [medicoSolicitanteId], references: [id])
  medicoDestino     Usuario?  @relation("InterconsultasRecibidas", fields: [medicoDestinoId], references: [id])

  @@index([pacienteId])
  @@index([medicoSolicitanteId])
  @@index([medicoDestinoId])
  @@index([especialidadDestino])
  @@index([estado])
  @@index([prioridad])
  @@index([fechaSolicitud])
}
